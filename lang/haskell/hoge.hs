{-# OPTIONS -Wall #-}
import Network.HTTP
-- import System.Timeout
import Text.HTML.TagSoup
import Text.HTML.TagSoup.Tree
import Data.Char (isSpace)  
import qualified Codec.Binary.UTF8.String as U

-- main = do
--   let url = "http://google.co.jp"
--   rsp <- timeout 50000000 $ simpleHTTP (getRequest url)
--   case rsp of
--     Just r -> getResponseBody r >>= putStrLn
--     Nothing -> putStrLn "timeout occures!"

-- http://shanon-tech.blogspot.jp/2012/01/haskell-web.html
openURL :: String -> IO String
openURL x = simpleHTTP (getRequest x) >>= getResponseBody

hrefs :: String -> IO [String]
hrefs url = do
  tags <- fmap parseTags $ openURL url
  let attrs = [head i | (TagOpen "a" i) <- tags]
  return [j| ("href", j) <- attrs]

-- fmap parseTags $ openURL url
-- の結果
-- hoge = [TagOpen "!DOCTYPE"
--             [("html",""),("PUBLIC",""),("","-//W3C//DTD XHTML 1.0 Transitional//EN"),("","http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd")],
--             TagText "\n",
--             TagOpen "html" [("xmlns","http://www.w3.org/1999/xhtml"),("xml:lang","ja"),("lang","ja")],
--                 TagText "\n",
--                 TagOpen "head" [],
--                     TagText "\n",
--                     TagOpen "meta" [("http-equiv","Content-Type"),("content","text/html; charset=shift_jis")],
--                     TagClose "meta",
--                     TagText "\n",
--                     TagOpen "meta" [("name","Keywords"),("content","\131V\131\131\131m\131\147\131E\131B\131\147\131h,\142\247\142\137\131T\131b\131V,\131G\131N\131Z\131\139\131V\131\131\131m\131\147")],
--                     TagClose "meta",
--                     TagText "\n",
--                     TagOpen "meta" [("name","Description"),("content","\147\250\150{\130\197\141\197\143\137\130\204\141\197\145\229\142\232\130\204\142\247\142\137\131T\131b\131V\131\129\129[\131J\129[\129A\131G\131N\131Z\131\139\131V\131\131\131m\131\147\130\178\143\208\137\238\129B")],
--                     TagClose "meta",TagText "\n",TagOpen "link" [("rel","stylesheet"),("href","style.css"),("type","text/css")],TagClose "link",TagText "\n",TagOpen "title" [],TagText "\131V\131\131\131m\131\147\131E\131B\131\147\131hfan",TagClose "title",TagText "\n",TagClose "head",TagText "\n\n",
--                     TagOpen "body" [],
--                         TagText "\n",
--                         TagOpen "div" [("id","container")],
--                             TagText "\n\n",
--                             TagOpen "h1" [],
--                                 TagText "\131V\131\131\131m\131\147\131E\131B\131\147\131h\130\198\130\205\129E\129E",TagClose "h1",TagText "\n\n",TagOpen "div" [("id","header")],TagText "\n",TagOpen "a" [("href","./")],TagText "\131V\131\131\131m\131\147\131E\131B\131\147\131hfan",TagClose "a",TagClose "div",TagComment " /header ",TagText "\n\n\n",TagOpen "div" [("id","navi")],TagText "\n",TagOpen "ul" [],TagText "\n",TagOpen "li" [],TagOpen "a" [("href","./")],TagText "HOME",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","sitemap.html")],TagText "\131T\131C\131g\131}\131b\131v",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","ask.html")],TagText "\137^\137c\142\210\143\238\149\241",TagClose "a",TagClose "li",TagText "\n",TagClose "ul",TagText "\n",TagClose "div",TagComment " /navi ",TagText "\n\n\n\n",TagOpen "div" [("id","content")],TagText "\n\n",TagOpen "div" [("id","main")],TagText "\n",TagOpen "div" [("id","main-inner")],TagText "\n\n",TagOpen "h2" [],TagText "\131V\131\131\131m\131\147\131E\131B\131\147\131h\130\198\130\205\129H",TagClose "h2",TagText "\n",TagOpen "div" [("class","main-cont")],TagText "\n",TagOpen "img" [("src","./images/index1.jpg"),("class","img_left")],TagClose "img",TagText "\n",TagOpen "p" [],TagText "\131G\131N\131Z\131\139\131V\131\131\131m\131\147\130\205\147\250\150{\130\197\141\197\143\137\130\204\129A\130\187\130\181\130\196\141\197\145\229\142\232\130\204\142\247\142\137\131T\131b\131V\131\129\129[\131J\129[\130\197\130\183\129B\131V\131\131\131m\131\147\131E\131B\131\147\131h\130\205\141\130\144\171\148\\\142\247\142\137\131T\131b\131V\130\197\130\183\129B\n\n\n",TagClose "p",TagText "\n",TagClose "div",TagText "\n\n",TagOpen "h3" [],TagText "\142\247\142\137\131T\131b\131V",TagClose "h3",TagText "\n",TagOpen "div" [("class","main-cont")],TagText "\n",TagOpen "img" [("src","./images/index2.jpg"),("class","img_right")],TagClose "img",TagText "\n",TagOpen "p" [],TagText "\142\247\142\137\131T\131b\131V\130\205\129A1955\148N\130\201\144\188\131h\131C\131c\130\197\146a\144\182\130\181\130\189\143\200\131G\131l\131^\131C\131v\130\204\144V\130\181\130\162\145\139\130\197\130\183\129B\147\250\150{\130\197\130\224\130\187\130\204\140\227\129A\139}\144\172\146\183\130\240\144\139\130\176\130\220\130\181\130\189\129B",TagOpen "br" [],TagClose "br",TagText "\n\147\193\130\201\147\250\150{\130\205\129A\141\130\137\183\145\189\142\188\130\204\146n\136\230\129A\140\181\138\166\145\189\144\225\130\204\146n\136\230\130\200\130\199\130\170\130\160\130\232\129A\136\234\148N\130\204\146\134\130\197\139C\143\219\143\240\140\143\130\204\141\183\130\170\145\229\130\171\130\162\136\215\130\201\129A\141\130\139C\150\167\129E\141\130\146f\148M\130\204\143Z\145\238\130\214\130\204\138\214\144S\130\170\141\130\130\220\130\193\130\196\130\162\130\220\130\183\129B",TagOpen "br" [],TagClose "br",TagText "\n\n\142\247\142\137\131T\131b\131V\130\204\146f\148M\144\171\148\\\130\204\140\252\143\227\130\198\130\198\130\224\130\201\129A\141\130\139C\150\167\129E\141\130\146f\148M\129A\130\181\130\169\130\224\140\139\152I\130\204\148\173\144\182\130\240\151}\130\166\130\233\151\157\145z\130\204\145\139\130\198\130\181\130\196\146\141\150\218\130\240\143W\130\223\130\196\130\162\130\220\130\183\129B",TagClose "p",TagText "\n",TagOpen "p" [],TagText "\130\187\130\241\130\200\146\134\130\197\129A\131G\131N\131Z\131\139\131E\131C\131\147\131h\130\205\131h\131C\131c\130\204\131\129\129[\131J\129[\130\230\130\232\139Z\143p\130\240\147\177\147\252\130\181\129A1981\148N\130\201\138J\148\173\130\179\130\234\130\189\141\130\146f\148M\142\247\142\137\131T\131b\131V\130\197\130\183\129B\131A\131\139\131~\136\234\143d\145\139\130\201\148\228\130\215\130\196\150\241 1/2.5\130\198\130\162\130\164\148M\138\209\151\172\151\166\130\204\146\225\130\179\129A20\150\156\137\241\130\201\130\224\139y\130\212\138J\149\194\131e\131X\131g\130\197\142\192\143\216\130\179\130\234\130\189\138\230\143\228\130\179\130\198\141\130\139C\150\167\144\171\130\240\130\205\130\182\130\223\129A\144\148\129X\130\204\139\193\130\173\130\215\130\171\144\171\148\\\130\240\130\162\130\169\130\241\130\200\130\173\148\173\138\246\130\181\129A\130\220\130\179\130\201\129u\142\159\144\162\145\227\130\204\145\139\129v\130\198\130\181\130\196\140\250\130\162\144M\151\138\130\240\147\190\130\196\130\171\130\220\130\181\130\189\129B\130\187\130\234\130\206\130\169\130\232\130\197\130\200\130\173\129A\151p\147r\129E\150\218\147I\130\201\130\160\130\237\130\185\130\189\145\189\142\237\145\189\151l\130\200\143\164\149i\140Q\129A\143Z\145\238\130\198\130\204\131R\129[\131f\131B\131l\129[\131g\130\204\149\157\130\240\141L\130\176\130\233\131J\131\137\129[\131o\131\138\131G\129[\131V\131\135\131\147\130\204\138J\148\173\130\200\130\199\129A\130\230\130\232\137\245\147K\130\197\145n\145\162\144\171\130\201\149x\130\241\130\190\143Z\130\220\130\162\130\195\130\173\130\232\130\201\141v\140\163\130\181\130\196\130\162\130\220\130\183\129B\141\161\129A\142\158\145\227\130\205\&21\144\162\139I\129B\144\207\130\221\143d\130\203\130\231\130\234\130\189\140\164\139\134\130\198\140o\140\177\130\204\130\183\130\215\130\196\130\170\129A\130\177\130\204\131}\129[\131N\130\201\140\234\130\232\140p\130\170\130\234\130\196\130\162\130\220\130\183\129B\145\139\141\219\130\201\151\167\130\194\130\160\130\200\130\189\130\170\144[\130\162\136\192\130\231\130\172\130\240\138\180\130\182\130\189\130\200\130\231\143\173\130\181\130\190\130\175\150\218\144\252\130\240\130\184\130\231\130\181\130\196\130\221\130\196\130\190\130\179\130\162\129B\130\187\130\177\130\201\130\205\130\171\130\193\130\198\131G\131N\131Z\131\139\131E\131C\131\147\131h\130\170\129E\129E\129E\129B",TagClose "p",TagText "\n",TagClose "div",TagText "\n\n",TagOpen "h3" [],TagText "\129y\143Z\145\238\129z\131j\131\133\129[\131X",TagClose "h3",TagText "\n",TagOpen "div" [("class","main-cont")],TagText "\n         ",TagOpen "img" [("src","./update/update.cgi?f=../index.html&k=\143Z\145\238&n=2&code=sjis"),("width","1"),("height","1")],TagText "\n         ",TagComment " insert_start ",TagText "\n\n         ",TagComment " insert_end ",TagText "\n",TagClose "div",TagText "\n\n\n",TagClose "div",TagComment " /main-inner ",TagText "\n",TagClose "div",TagComment " /main ",TagText "\n\n\n\n",TagOpen "div" [("id","sub")],TagText "\n",TagOpen "div" [("id","sub-inner")],TagText "\n\n",TagOpen "div" [("class","sub-title")],TagText "\131T\131C\131gMENU",TagClose "div",TagText "\n",TagOpen "div" [("class","sub-cont")],TagText "\n",TagOpen "ul" [],TagText "\n",TagOpen "li" [],TagOpen "a" [("href","./")],TagText "HOME",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","products/index.html")],TagText "\141\130\139C\150\167\143Z\145\238",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","products/02.html")],TagText "\141\130\146f\148M\143Z\145\238",TagClose "a",TagClose "li",TagText "\n",TagClose "ul",TagText "\n",TagClose "div",TagText "\n\n",TagOpen "div" [("class","sub-title")],TagText "\143Z\145\238\130\198\130\205\129H",TagClose "div",TagText "\n",TagOpen "div" [("class","sub-cont")],TagText "\n",TagOpen "p" [],TagText "\143Z\145\238\130\198\130\205\129A\144l\130\204\139\143\143Z\130\240\151p\147r\130\198\130\183\130\233\140\154\146z\149\168\129B\129u\143Z\139\143\129v\129E\129u\131}\131C\131z\129[\131\128\129v\130\198\130\224\140\190\130\164\129B\142\252\136\205\130\204\138\194\139\171\130\169\130\231\143Z\144l\130\204\137\245\147K\130\200\144\182\138\136\130\240\142\231\130\233\130\224\130\204\130\197\130\160\130\232\129A\144\182\138\136\148\205\136\205\130\198\130\200\130\233\138\194\139\171\130\240\138\220\130\223\130\233\143\234\141\135\130\224\130\160\130\233\129B",TagOpen "br" [],TagText "\n\n\130\177\130\177\130\197\140\190\130\164\129g\142\252\136\205\130\204\138\194\139\171\129h\130\198\130\205\129A\139C\140\243\129i\137J\129A\149\151\129A\144\225\129A\143\139\130\179\129A\138\166\130\179\129A\142\188\139C\130\200\130\199\129j\129A\145\155\137\185\129A\136\217\143L\129A\145\188\144l\130\204\142\139\144\252\130\226\149\183\130\171\142\168\129i\129\168\131v\131\137\131C\131o\131V\129[\130\204\149\219\140\236\129j\129A\147V\147G\129i\150\210\143b\129A\150\210\139\215\129A\138Q\146\142\130\200\130\199\129j\130\200\130\199\129A\151\167\146n\143\240\140\143\130\201\130\230\130\193\130\196\136\217\130\200\130\233\130\224\130\204\130\197\130\160\130\232\129A\143Z\145\238\130\201\139\129\130\223\130\231\130\234\130\233\145\206\137\158\130\224\130\187\130\234\130\201\130\230\130\193\130\196\136\217\130\200\130\233\129B",TagOpen "br" [],TagText "\n",TagOpen "br" [],TagText "\n\130\208\130\198\130\194\130\204\149~\146n\130\201\136\234\144\162\145\209\130\170\139\143\143Z\130\183\130\233\129u\136\234\140\203\140\154\129v\129i\140\203\140\154\129A\140\194\144l\143Z\145\238\130\198\130\224\140\190\130\164\129j\130\198\129A\149\161\144\148\144\162\145\209\130\170\139\143\143Z\130\183\130\233\129u\143W\141\135\143Z\145\238\129v\129i\140\154\146z\138\238\143\128\150@\130\201\130\168\130\162\130\196\130\205\139\164\147\175\143Z\145\238\130\198\140\190\130\164\129j\130\198\130\201\145\229\149\202\130\179\130\234\130\233\129B\130\220\130\189\129A\142\169\140\200\130\170\143\138\151L\130\181\139\143\143Z\130\183\130\233\142\157\130\191\137\198\130\198\129A\145\188\144l\130\170\143\138\151L\130\183\130\233\143Z\145\238\130\240\142\216\130\232\130\196\139\143\143Z\130\183\130\233\145\221\137\198\129i\145\221\138\212\129j\129E\146\192\145\221\143Z\145\238\130\201\149\170\130\175\130\233\130\177\130\198\130\224\130\197\130\171\130\233\129B",TagOpen "br" [],TagText "\n",TagOpen "br" [],TagText "\n\130\187\130\204\140`\130\201\130\205\129A\142\208\137\239\130\204\149\207\137\187\130\201\137\158\130\182\130\196\151\172\141s\130\224\130\160\130\232\129A\152a\149\151\143Z\145\238\129A\151m\149\151\129A\137\162\149\151\143Z\145\238\130\198\130\162\130\193\130\189\140\196\130\209\150\188\130\170\130\160\130\232\129A\130\220\130\189\129A\141\130\151\238\142\210\130\204\141\221\145\238\131P\131A\130\200\130\199\130\204\130\189\130\223\130\204\147\175\139\143\130\183\130\233\144l\130\170\145\157\130\166\130\233\130\230\130\164\130\201\130\200\130\232\129A\147\241\144\162\145\209\129A\142O\144\162\145\209\143Z\145\238\130\226\129A\141\130\151\238\142\210\143Z\145\238\129A\131o\131\138\131A\131t\131\138\129[\143Z\145\238\130\198\130\162\130\193\130\189\140\196\143\204\130\224\143o\130\196\130\171\130\189\129B",TagOpen "br" [],TagOpen "br" [],TagOpen "font" [("size","1")],TagText "[\131E\131B\131L\131y\131f\131B\131A\129iWikipedia\129j\130\230\130\232]",TagClose "font",TagClose "p",TagText "\n",TagClose "div",TagText "\n\n",TagClose "div",TagComment " /sub-inner ",TagText "\n",TagClose "div",TagComment " /sub ",TagText "\n\n",TagClose "div",TagComment " /content ",TagText "\n\n\n",TagOpen "div" [("id","footer")],TagText "\n\n",TagOpen "div" [("id","footer-menu")],TagText "\n",TagOpen "ul" [],TagText "\n",TagOpen "li" [],TagOpen "a" [("href","./")],TagText "HOME",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","sitemap.html")],TagText "\131T\131C\131g\131}\131b\131v",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","ask.html")],TagText "\137^\137c\142\210\143\238\149\241",TagClose "a",TagClose "li",TagOpen "br" [],TagText "\n",TagOpen "li" [],TagText "[PR] ",TagOpen "a" [("href","http://mizu.takuhai1.info/"),("target","_blank")],TagText "\144\133\145\238\148z",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","http://clytia25.net/"),("target","_blank")],TagText "\131E\131H\129[\131^\129[\131T\129[\131o\129[",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","http://www.present1.com/"),("target","_blank")],TagText "\138\210\151\239\143j\130\162",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","http://jw12.net/"),("target","_blank")],TagText "\131W\131\133\131G\131\138\129[",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","http://303030.jp/VPAZ-7006/"),("target","_blank")],TagText "\137p\140\234\138w\143K",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","http://soba.soft99.info/"),("target","_blank")],TagText "\130\187\130\206\130\204\145\197\130\191\149\251",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","http://www.judg.biz/"),("target","_blank")],TagText "\144\169\150\188\148\187\146f",TagClose "a",TagClose "li",TagOpen "br" [],TagText "\n",TagOpen "li" [],TagText "[PR] ",TagOpen "a" [("href","http://www.11j.jp/"),("target","_blank")],TagText "\140\162\151p\149i",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","http://pwr.jp/"),("target","_blank")],TagText "\131\140\131\147\131^\131\139\131T\129[\131o\129[",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","http://www.keysoft.co.jp/ozone/"),("target","_blank")],TagText "\131}\131\147\131V\131\135\131\147 \131\138\131t\131H\129[\131\128",TagClose "a",TagClose "li",TagText "\n",TagOpen "li" [],TagOpen "a" [("href","http://www.shanon.jp/w-pipe/"),("target","_blank")],TagText "\131I\131]\131\147\144\244\143\242",TagClose "a",TagClose "li",TagText "\n\n",TagClose "ul",TagText "\n",TagClose "div",TagText "\n\n",TagOpen "address" [],TagText "Copyright (C) \131V\131\131\131m\131\147\131E\131B\131\147\131hfan. All Rights Reserved.",TagClose "address",TagText "\n\n",TagClose "div",TagComment " /footer ",TagText "\n",TagClose "div",TagComment " /container ",TagText "\n\n",TagComment " \131A\131N\131Z\131X\137\240\144\205 ",TagText "\n\n",TagClose "body",TagText "\n",TagClose "html",TagText "\n"]

trim :: String -> String
trim = f . f
  where f = reverse . dropWhile isSpace

getSchools :: IO [[[String]]]
getSchools = do
  tags <- fmap parseTags $ openURL "http://www.city.funabashi.chiba.jp/kodomo/school/0004/p008678.html"
  let tree = tagTree tags
  -- trを取り出す(先頭2つと末尾は除く)
  let schools = map doRow (init $ drop 2 $ [x | (TagBranch "tr" _ x) <- universeTree tree])
  return schools
  where
    doRow :: [TagTree String] -> [[String]]
    doRow xs = map doCell [x|(TagBranch "td" _ x) <- xs]
    doCell :: [TagTree String] -> [String]
    doCell xs = [U.decodeString $ trim $ fromTagText t | t@(TagText _) <- flattenTree xs]
